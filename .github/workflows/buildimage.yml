name: Build New Release

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:


jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Install Required Packages
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y coreutils quilt parted qemu-user-static debootstrap zerofree zip \
          dosfstools libarchive-tools libcap2-bin grep rsync xz-utils file git curl bc \
          qemu-utils kpartx gpg pigz

      - name: Checkout pi-gen Repository
        uses: actions/checkout@v4
        with:
          repository: 'RPi-Distro/pi-gen'
          ref: bullseye-arm64

      - name: Checkout Custom Post-Stage
        uses: actions/checkout@v4
        with:
          path: 'post-stage'
          sparse-checkout: |
            pi-gen

      - name: Checkout Extra Files
        uses: actions/checkout@v4
        with:
          path: 'extra'
          sparse-checkout: |
            changelog.txt
            config.txt

      - name: Modify pi-gen
        run: |
          mv extra/config.txt config
          TITLE=$(head -n 1 extra/changelog.txt)
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV
          CHANGELOG=$(cat extra/changelog.txt)
          echo "$CHANGELOG"
          echo "" >> config
          echo "IMG_NAME='switch-pi-bot-${TITLE}'" >> config
          cat config
          rm -f stage2/EXPORT*
          rm -rf stage3
          rm -rf stage4
          rm -rf stage5
          chmod -R +x post-stage

      - name: Build Image
        run: |
          CONTINUE=1 ./build-docker.sh

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_name: Alpha ${{ env.RELEASE_TITLE }}
          body: ${{ env.CHANGELOG }}
          draft: false
          prerelease: false

      - name: Add Image to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: deploy/*.img.xz
          asset__name: switch-pibot-${{ env.RELEASE_TITLE }}.img
          asset_content_type: application/octet-stream
