name: Build New Release

on:
  push:
    branches:
      - '**'
  workflow_dispatch:


jobs:
  build-image:
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
    steps:
      - name: Cleanup Build Folder
        run: |
          rm -rf ./*.img
          rm -rf ./*.img.xz
          rm -rf ./src
          rm -rf ./finalsize

      - name: Install Required Packages
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y mount \
          sudo \
          bash \
          e2fsprogs \
          wget \
          xz-utils \
          util-linux \
          qemu-user-static \
          docker \
          docker.io \
          containerd

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: 'src'

      - name: Build Docker Image
        run: |
          update-binfmts --enable qemu-arm
          update-binfmts --enable qemu-aarch64
          docker build --platform linux/arm/v7 -t build-img:1.0 ./src/docker/.

      - name: Create Loopback Device
        run: |
          wget -O base.img.xz https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-07-04/2024-07-04-raspios-bookworm-arm64-lite.img.xz
          xz -vd base.img.xz
          dd if=/dev/zero of=pi-bot.img bs=1M count=3900
          LOOPBACK=$(losetup -f)
          echo "LOOPBACK=$LOOPBACK" >> $GITHUB_ENV
          echo "${{ env.LOOPBACK }}"
          losetup -v ${{ env.LOOPBACK }} pi-bot.img
          OLD_IMG=$(losetup -f)
          echo "OLD_IMG=$OLD_IMG" > $GITHUB_ENV
          losetup -v ${{ env.OLD_IMG }} base.img
          dd if=${{ env.OLD_IMG }} of=${{ env.LOOPBACK }}
          parted ${{ env.LOOPBACK }} --script -- resizepart 2 100%
          echo "PI_ROOT=${{ env.LOOPBACK }}p2" >> $GITHUB_ENV
          e2fsck -yf ${{ env.PI_ROOT }}
          resize2fs ${{ env.PI_ROOT }}
          rm base.img

      - name: Build Pi Image
        run: |
          mkdir -p finalsize
          docker run --rm -it --privileged \
          -e PI_ROOT=${{ env.PI_ROOT }}
          --platform linux/arm/v7 \
          -v ${{ env.PI_ROOT }}:${{ env.PI_ROOT }} \
          -v src:/src \
          -v finalsize:/finalsize \
          build-img:1.0

      - name: Shrink Image
        run: |
          MIN_SIZE=$(cat finalsize/bytes)
          PARTED_SIZE=$(($MIN_SIZE / 1024 / 1024))M
          parted ${{ env.LOOPBACK }} --script resizepart 2 $PARTED_SIZE
          END_SECTOR=$(fdisk -l "${{ env.LOOPBACK }}" | grep "${{ env.PI_ROOT }}" | awk '{print $3}'
          IMG_SIZE=$(($END_SECTOR * 512))
          truncate --size=$IMG_SIZE pi-bot.img

      - name: Get Release Details
        run: |
          CHANGELOG=$(cat src/changelog.txt)
          echo "CHANGELOG=$CHANGELOG" >> $GITHUB_ENV
          TITLE=$(head -n 1 ${{ env.CHANGE }})
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_ENV

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: Alpha
          release_name: Alpha ${{ env.RELEASE_TITLE }}
          body: ${{ env.CHANGELOG }}
          draft: false
          prerelease: false

      - name: Add Image to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: pi-bot.img
          asset_name: switch-pibot-${{ env.RELEASE_TITLE }}.img
          asset_content_type: application/octet-stream
